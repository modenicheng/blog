---
title: 原琴演奏中高精度计时解决方案
createTime: 2025/07/22 21:20:13
permalink: /article/u34an1f4/

tags: 
    - 原神
    - 原琴
    - 音乐
    - Midi
---

## 0. 引言——为什么有这篇文章？

在做「寰墟之叹」原琴视频的时候，我们主要采用 Midi 文件自动化演奏的方式制作!!因为没有手（!!。在开源社区，有诸多优秀的演奏脚本，在尝试很多脚本后我们发现：后期合并音轨的时候总是对不齐，且越靠后越乱。总之最后找到了原因和解决方法，故记录在此。

## 1. 问题原因

目前，很多支持 Midi 演奏的脚本均基于 Python 开发。比如：

<RepoCard repo="WitchElaina/Genshin_Zither_Player" />

这种脚本整体设计上并未有很大问题，部分功能也相当出色，然而在它们的计时部分却不够精确。虽足以应付独奏时的时间控制，但是会因为阻塞运行的指令而积累误差，导致计时精度下滑。

```python:line-numbers=60 title="Genshin_Zither_Player/GenshinZitherPlayer.py"
def playMidi(m_file_name, m_bpm, m_key_add):
    file_name = "." + os.sep + "midi_repo" + os.sep + m_file_name
    
    real_time = float( 120 / m_bpm ) 
    
    midi = mido.MidiFile(file_name)
    
    # set bpm
    tempo = mido.bpm2tempo(m_bpm)
    
    # Read midi file
    for msg in midi:
        if(msg.type=="note_on"):
            # Press
            sleep_time = float(msg.time) * real_time
            pyautogui.sleep(sleep_time) # [!code highlight]
            pyautogui.keyDown(noteTrans(int(msg.note)+m_key_add))
            pyautogui.keyUp(noteTrans(int(msg.note)+m_key_add))
            
        elif(msg.type=="note_off"):
            # Release
            sleep_time = float(msg.time) * real_time
            pyautogui.sleep(sleep_time)
            
        else:
            continue 
```

具体而言，`pyautogui.sleep()` 函数计时精度并不足够高，多次执行后误差逐渐积累，导致后续计时精度不够。此外， 76 行和 77 行按键的操作也较为耗时，导致一个循环内实际上消耗时间略多于指定的时间，不断积累，最终造成不可忽略的影响。

## 2. 解决方案

首先可以自己搓一个新的计时机制出来，利用异步编程的任务队列避免积累误差。

不过秉持不重复造轮子的态度!!（就是懒）!!，我们可以借助以下三个免费软件直接实现高精度的原琴演奏：FreePiano、loopMidi和MidiKey2Key。

### 软件的简要介绍

#### FreePiano

官网：<https://freepiano.tiwb.com/cn/>

一款虚拟 Midi 键盘，把正常 108 键键盘输入映射到 Midi 信号。不过在这里它并不是干这个的。我们需要它的 Midi 播放功能。

#### loopMidi

官网：<https://www.tobias-erichsen.de/software/loopmidi.html>

一款 Midi 信号路由工具，可以创建虚拟的 Midi In 和 Midi Out，并在其间传输 Midi 信号。

#### MidiKey2Key

官网：<https://midikey2key.de/?lang=en>

一款 Midi 信号到键盘键位的映射工具。

### 解决思路

FreePiano 作为 Midi 信号源，通过 loopMidi 将信号输入到 MidKey2Key，并映射成原琴键位。

!!其实就是用 FreePiano 作为高精度 Midi 解析与播放装置罢了……!!

### 上操作

> [!NOTE]
> 软件安装请自行解决。
