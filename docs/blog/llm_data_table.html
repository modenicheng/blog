<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Data Table</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .rendered-markdown {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
    }
    .rendered-markdown h1,
    .rendered-markdown h2,
    .rendered-markdown h3,
    .rendered-markdown h4,
    .rendered-markdown h5,
    .rendered-markdown h6 {
      margin-top: 1em;
      margin-bottom: 0.5em;
      font-weight: bold;
    }
    .rendered-markdown h1 { font-size: 1.5em; }
    .rendered-markdown h2 { font-size: 1.3em; }
    .rendered-markdown h3 { font-size: 1.1em; }
    .rendered-markdown p {
      margin-bottom: 1em;
    }
    .rendered-markdown ul,
    .rendered-markdown ol {
      padding-left: 2em;
      margin-bottom: 1em;
    }
    .rendered-markdown blockquote {
      border-left: 3px solid #ddd;
      padding-left: 1em;
      margin-left: 0;
      color: #666;
    }
    .rendered-markdown code {
      background-color: #f5f5f5;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
      font-size: 0.9em;
    }
    .rendered-markdown pre {
      background-color: #f5f5f5;
      padding: 1em;
      border-radius: 5px;
      overflow-x: auto;
    }
    .rendered-markdown pre code {
      background-color: transparent;
      padding: 0;
    }

    .quest-section {
      background-color: #fff;
    }
    .content-cell {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background-color: #f8f9fa;
    }
    .reasoning-cell {
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background-color: #f8f9fa;
    }
    table {
      table-layout: fixed;
    }
    table th {
      width: 150px;
    }
    table td {
      vertical-align: top;
    }
    .collapse-btn[aria-expanded="true"]::after {
      content: " ▲";
    }
    .collapse-btn[aria-expanded="false"]::after {
      content: " ▼";
    }
    .collapse-btn {
      text-decoration: none;
      color: #495057;
    }
    .collapse-btn:hover {
      color: #0d6efd;
    }
  </style>
</head>

<body>
  <script type="module">
    let data = null;
    let tableRendered = false;

    // Show loading state initially
    const container = document.getElementById('main-table');
    if (container) {
      container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading data...</p></div>';
    }

    // Helper function to check if element is in viewport
    function isElementInViewport(el) {
      if (!el) return false;
      const rect = el.getBoundingClientRect();
      return (
        rect.top <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.bottom >= 0 &&
        rect.left <= (window.innerWidth || document.documentElement.clientWidth) &&
        rect.right >= 0
      );
    }

    // Load data first
    try {
      const response = await fetch("../.vuepress/public/data/llm_experience_score.json");
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      data = await response.json();
      console.log('Data loaded successfully:', data);

      // Update loading state to indicate data is ready
      if (container) {
        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Ready</span></div><p class="mt-2">Data loaded. Scroll down to view table...</p></div>';
      }

      // Check if container is already in viewport
      if (!container) {
        console.error('Container #main-table not found');
        throw new Error('Container #main-table not found');
      }

      if (isElementInViewport(container) && !tableRendered) {
        console.log('Container already in viewport, rendering immediately...');
        renderTable(data);
        tableRendered = true;
      } else {
        // Set up intersection observer for lazy rendering
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting && data && !tableRendered) {
              console.log('Container is in viewport, rendering table...');
              renderTable(data);
              tableRendered = true;
              observer.unobserve(container); // Stop observing after rendering
            }
          });
        }, {
          root: null, // viewport
          threshold: 0.1, // trigger when 10% of element is visible
          rootMargin: '0px 0px 50px 0px' // load slightly before element comes into view
        });

        observer.observe(container);
      }
    } catch (error) {
      console.error('Error loading data:', error);
      if (container) {
        container.innerHTML = '<div class="alert alert-danger" role="alert">Error loading data: ' + error.message + '</div>';
      }
    }

    function renderTable(data) {
      const container = document.getElementById('main-table');
      if (!container) {
        console.error('Container #main-table not found');
        return;
      }

      container.innerHTML = '';

      data.forEach(task => {
        const { quest_id, aspect, judgement, prompt, data: responses } = task;

        // Create section for each quest
        const section = document.createElement('div');
        section.className = 'quest-section mb-5 p-3 border rounded';

        // Title
        const title = document.createElement('h3');
        title.textContent = `Quest ${quest_id}: ${aspect}`;
        section.appendChild(title);

        // User prompt
        const promptDiv = document.createElement('div');
        promptDiv.className = 'prompt mb-3 p-3 bg-light';
        promptDiv.innerHTML = `<strong>User Prompt:</strong><div class="rendered-markdown">${window.marked ? window.marked.parse(prompt) : escapeHtml(prompt)}</div>`;
        section.appendChild(promptDiv);

        // Judgement
        if (judgement && judgement.trim()) {
          const judgementDiv = document.createElement('div');
          judgementDiv.className = 'judgement mb-3 p-3 bg-light';
          judgementDiv.innerHTML = `<strong>Judgement:</strong><div class="rendered-markdown">${window.marked ? window.marked.parse(judgement) : escapeHtml(judgement)}</div>`;
          section.appendChild(judgementDiv);
        }

        // Create table for this quest
        const table = document.createElement('table');
        table.className = 'table table-bordered table-hover';

        // Table header - models
        const thead = document.createElement('thead');
        thead.className = 'table-dark';
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `<th>Model</th>${responses.map(resp => `<th>${escapeHtml(resp.model)}<br><small class="text-muted">${escapeHtml(resp.platform)}</small></th>`).join('')}`;
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Table body
        const tbody = document.createElement('tbody');

        // Content row (no collapse)
        const contentRow = document.createElement('tr');
        contentRow.innerHTML = `<th class="table-secondary">Content</th>${responses.map(resp => `
          <td>
            <div class="content-cell">
              <div class="rendered-markdown">${window.marked ? window.marked.parse(resp.content) : escapeHtml(resp.content)}</div>
            </div>
          </td>
        `).join('')}`;
        tbody.appendChild(contentRow);

        // Reasoning row (collapsed by default)
        const reasoningRow = document.createElement('tr');
        const reasoningRowId = `reasoning-${quest_id}`;
        reasoningRow.innerHTML = `<th class="table-secondary">
          <button class="btn btn-sm btn-link p-0 collapse-btn" type="button" data-bs-toggle="collapse" data-bs-target="#${reasoningRowId}" aria-expanded="false" aria-controls="${reasoningRowId}">
            Reasoning
          </button>
        </th>${responses.map(resp => `
          <td>
            <div class="collapse" id="${reasoningRowId}">
              <div class="reasoning-cell">
                ${resp.reasoning && resp.reasoning.trim() ?
                  `<div class="rendered-markdown">${window.marked ? window.marked.parse(resp.reasoning) : escapeHtml(resp.reasoning)}</div>` :
                  `<span class="text-muted fst-italic">no data</span>`}
              </div>
            </div>
          </td>
        `).join('')}`;
        tbody.appendChild(reasoningRow);

        // Score row
        const scoreRow = document.createElement('tr');
        scoreRow.innerHTML = `<th class="table-secondary">Score</th>${responses.map(resp => `
          <td>
            <div class="text-center fw-bold">${escapeHtml(resp.score)}</div>
          </td>
        `).join('')}`;
        tbody.appendChild(scoreRow);

        // Comment row
        const commentRow = document.createElement('tr');
        commentRow.innerHTML = `<th class="table-secondary">Comment</th>${responses.map(resp => `
          <td>${resp.comment && resp.comment.trim() ? escapeHtml(resp.comment) : '<span class="text-muted">—</span>'}</td>
        `).join('')}`;
        tbody.appendChild(commentRow);

        table.appendChild(tbody);
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-responsive';
        tableWrapper.appendChild(table);
        section.appendChild(tableWrapper);
        container.appendChild(section);
      });
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

  </script>
  <div id="main-table"></div>

</body>